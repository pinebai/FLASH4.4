!!****if* source/physics/RadTrans/RadTransMain/RadTrans_planckInt
!!
!!  NAME 
!!
!!  RadTrans_planckInt
!!
!!  SYNOPSIS
!!
!!  call RadTrans_planckInt(real(IN)  :: x,
!!                          real(OUT) :: p)
!!
!!  DESCRIPTION 
!!      This subroutine evaluates the Planck integral using a table
!!      lookup
!!
!!      The Planck integral is:
!!      
!!             x |\        y^3
!!      P(x) =   |  dy ----------
!!             0\|     exp(y) - 1
!!
!!
!! ARGUMENTS
!!
!!   x : The argument for the planck integral
!!   p : The value of the integral
!!
!!***

#ifdef DEBUG_ALL
#define DEBUG_RADTRANS
#endif

subroutine RadTrans_planckInt(x, p)

  implicit none

  ! Arguments:
  real, intent(in)  :: x
  real, intent(out) :: p

  ! Local variables:
  real :: xlog
  real :: arg
  real :: xii
  integer :: ii
  
  integer, parameter :: NPTS = 100
  real, parameter :: XMIN = 0.001, XMAX = 30.0
  real            :: LOGXMIN, LOGXMAX
  real            :: DXLOG
  real, parameter :: PI4_O_FIFTEEN = 6.493939402266828

  real, parameter :: pvals(100) = (/ &
      -2.182225314592601e+01, -2.150990180037523e+01, -2.119755497245271e+01, &
      -2.088521315808107e+01, -2.057287690763882e+01, -2.026054683194412e+01, &
      -1.994822360889609e+01, -1.963590799084783e+01, -1.932360081279034e+01, &
      -1.901130300143829e+01, -1.869901558531621e+01, -1.838673970595647e+01, &
      -1.807447663033201e+01, -1.776222776466040e+01, -1.744999466973145e+01, &
      -1.713777907792513e+01, -1.682558291212378e+01, -1.651340830668927e+01, &
      -1.620125763078861e+01, -1.588913351429104e+01, -1.557703887654005e+01, &
      -1.526497695832015e+01, -1.495295135737764e+01, -1.464096606789604e+01, &
      -1.432902552437310e+01, -1.401713465039838e+01, -1.370529891288903e+01, &
      -1.339352438240681e+01, -1.308181780025345e+01, -1.277018665312481e+01, &
      -1.245863925619824e+01, -1.214718484563367e+01, -1.183583368158928e+01, &
      -1.152459716298890e+01, -1.121348795543243e+01, -1.090252013381721e+01, &
      -1.059170934143773e+01, -1.028107296756036e+01, -9.970630345730457e+00, &
      -9.660402975369001e+00, -9.350414769558723e+00, -9.040692332314654e+00, &
      -8.731265269087835e+00, -8.422166534774727e+00, -8.113432824109058e+00, &
      -7.805105010011338e+00, -7.497228636278945e+00, -7.189854471934168e+00, &
      -6.883039135628768e+00, -6.576845799753478e+00, -6.271344985343733e+00, &
      -5.966615460534702e+00, -5.662745257225153e+00, -5.359832822785696e+00, &
      -5.057988326111292e+00, -4.757335140079680e+00, -4.458011525525746e+00, &
      -4.160172545134207e+00, -3.863992239094174e+00, -3.569666097773527e+00, &
      -3.277413869757589e+00, -2.987482745869292e+00, -2.700150960485473e+00, &
      -2.415731849426415e+00, -2.134578397196081e+00, -1.857088292865132e+00, &
      -1.583709489809186e+00, -1.314946224789572e+00, -1.051365389607380e+00, &
      -7.936030546884294e-01, -5.423708069943293e-01, -2.984613710159750e-01, &
      -6.275271679773423e-02,  1.637904895278921e-01,  3.801196741568375e-01, &
      5.851114771902219e-01,  7.775858446624189e-01,  9.563362017166011e-01, &
      1.120175039227148e+00,  1.267997922200626e+00,  1.398867632178341e+00, &
      1.512117340178169e+00,  1.607466801815886e+00,  1.685138270177674e+00, &
      1.745949728402005e+00,  1.791354659073111e+00,  1.823395250845586e+00, &
      1.844547214285368e+00,  1.857464290253036e+00,  1.864673172079114e+00, &
      1.868302963194416e+00,  1.869929858233146e+00,  1.870569844998334e+00, &
      1.870787526031948e+00,  1.870850524246492e+00,  1.870865768190390e+00, &
      1.870868793637970e+00,  1.870869275819693e+00,  1.870869336103461e+00, &
      1.870869341864745e+00 /)

  LOGXMIN = log(XMIN)
  LOGXMAX = log(XMAX)
  DXLOG = (LOGXMAX-LOGXMIN)/(NPTS-1)
  
  if (x < 1.001*XMIN) then
     p = 8.0*log((x+2)/2.0) + x*x - 4*x

  elseif (x > XMAX) then
     p = PI4_O_FIFTEEN - &
          exp(-x)*(x*x*x + 3*x*x + 6*x + 6) - &
          exp(-2*x)*(4*x*x*x + 6*x*x + 6*x + 3)/8.0

  else
     xlog = log(x)
     ii = (xlog - LOGXMIN) / DXLOG + 1
     xii = LOGXMIN + (ii-1)*DXLOG
  
#ifdef DEBUG_RADTRANS
     if(ii < 0 .or. ii >= NPTS-1) then
        print*,'[planckInt] x,xlog,ii,xii=',x,xlog,ii,xii
    !    ! Driver_abortFlash(ERROR MESSAGE)
     end if
#endif

    arg = pvals(ii) + (xlog-xii) * (pvals(ii+1)-pvals(ii)) / DXLOG
    p = exp(arg)
  end if
  

end subroutine RadTrans_planckInt
